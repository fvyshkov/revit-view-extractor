# Система координат для аннотаций в Revit

Этот документ описывает систему координат и правила преобразования, используемые для отображения аннотаций на экспортированных изображениях видов Revit.

## Системы координат

### 1. Координаты модели Revit (3D)
- **XYZ** - трехмерные координаты в пространстве модели Revit
- Для фасадов и разрезов:
  - **X** - горизонтальная ось (слева направо)
  - **Y** - глубина (перпендикулярно плоскости вида)
  - **Z** - вертикальная ось (снизу вверх)

### 2. Координаты плоскости вида (2D)
- **bbox2D** - двумерные координаты в плоскости вида
- Для фасадов:
  - **X** - горизонтальная ось (слева направо)
  - **Y** - вертикальная ось (снизу вверх в Revit, но в файле может быть инвертирована)

### 3. Нормализованные координаты (UV)
- **uvBBox** - нормализованные координаты в диапазоне [0,1]
- **u** - горизонтальная ось (0 = левый край, 1 = правый край)
- **v** - вертикальная ось (0 = нижний край, 1 = верхний край)

### 4. Координаты относительно углов вида (Viewport)
- **bboxViewport** - нормализованные координаты относительно углов вида
- **u** - горизонтальная ось (0 = левый край, 1 = правый край)
- **v** - вертикальная ось (0 = нижний край, 1 = верхний край)

### 5. Пиксельные координаты
- **pixelViewport** - координаты в пикселях изображения
- **x** - горизонтальная ось (0 = левый край)
- **y** - вертикальная ось (0 = верхний край) - ВАЖНО: Y-ось инвертирована относительно v!

## Преобразование координат

### Из bboxViewport в пиксельные координаты
```python
# Для bboxViewport координаты
u1 = float(min["u"]); v1 = float(min["v"]) 
u2 = float(max["u"]); v2 = float(max["v"]) 

# Преобразование в пиксели
x1 = int(max(0,min(1,u1))*img_w)
x2 = int(max(0,min(1,u2))*img_w)

# ВАЖНО: инвертировать Y-координаты, так как v=0 это низ, а y=0 это верх изображения
y1 = int((1.0 - max(0,min(1,v2)))*img_h)
y2 = int((1.0 - max(0,min(1,v1)))*img_h)
```

### Из bbox2D в пиксельные координаты (для фасадов)
```python
# Получаем координаты углов вида
tlx = viewportCorners["TopLeft"]["x"]
tlz = viewportCorners["TopLeft"]["z"]  # верхняя Z
trx = viewportCorners["TopRight"]["x"]
blz = viewportCorners["BottomLeft"]["z"]  # нижняя Z

# Координаты bbox2D
model_x1 = float(bbox2D["min"]["x"])
model_y1 = float(bbox2D["min"]["y"])  # в Revit это Z для фасадов
model_x2 = float(bbox2D["max"]["x"])
model_y2 = float(bbox2D["max"]["y"])  # в Revit это Z для фасадов

# Для фасадов, Y-координаты в bbox2D соответствуют Z в модели
# Поэтому мы инвертируем их для правильного отображения
model_z1 = -model_y1
model_z2 = -model_y2

# Нормализация координат
u1 = (model_x1 - tlx) / (trx - tlx)
u2 = (model_x2 - tlx) / (trx - tlx)
v1 = (model_z1 - blz) / (tlz - blz)
v2 = (model_z2 - blz) / (tlz - blz)

# Ограничение в диапазоне [0,1]
u1 = max(0.0, min(1.0, u1))
u2 = max(0.0, min(1.0, u2))
v1 = max(0.0, min(1.0, v1))
v2 = max(0.0, min(1.0, v2))

# Преобразование в пиксели с инверсией Y
x1 = int(u1 * img_w)
x2 = int(u2 * img_w)
y1 = int((1.0 - v2) * img_h)
y2 = int((1.0 - v1) * img_h)
```

## Особенности и проблемы

1. **Инверсия Y-координат**: Самая частая проблема - несоответствие между Y-координатами в Revit и Y-координатами в изображении. В Revit Y (или Z для фасадов) увеличивается снизу вверх, а в изображении Y увеличивается сверху вниз.

2. **Фасады и разрезы**: Для фасадов и разрезов вертикальная ось в Revit - это Z, но в экспортированных данных она может быть представлена как Y в bbox2D.

3. **Координаты за пределами вида**: Некоторые аннотации могут иметь координаты за пределами видимой области вида (отрицательные значения или значения больше 1 в нормализованных координатах). Такие координаты нужно ограничивать в диапазоне [0,1].

4. **Точность**: Из-за округления при преобразовании координат могут возникать небольшие смещения. Рекомендуется использовать минимальный размер бокса (например, 8 пикселей) для обеспечения видимости аннотаций.

## Рекомендации

1. Всегда проверяйте, что координаты углов вида (viewportCorners) доступны и используйте их для нормализации координат.

2. Для фасадов и разрезов проверяйте, какая ось (Y или Z) используется для вертикальных координат.

3. Не забывайте инвертировать Y-координаты при преобразовании из нормализованных координат в пиксельные.

4. Устанавливайте минимальный размер бокса для обеспечения видимости аннотаций.

5. Для отладки используйте режим отображения только угловых маркеров (--corners-only), чтобы убедиться, что система координат правильно настроена.
